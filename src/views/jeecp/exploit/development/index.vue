<template>
  <d2-container>
    <!-- header 查询条件 -->
    <template slot="header">
      <div style="float: right">
        <el-button type="primary" @click="handleAdd">添加模块</el-button>
      </div>
    </template>
    <el-table :data="list" style="width: 100%">
      <el-table-column label="序号" align="center" width="50">
        <template slot-scope="scope">
          <span style="margin-left: 10px">{{ scope.row.id }}</span>
        </template>
      </el-table-column>
      <el-table-column label="模块名称" align="center">
        <template slot-scope="scope">
          <span style="margin-left: 10px">{{ scope.row.name }}</span>
        </template>
      </el-table-column>
      <el-table-column label="图标" align="center">
        <template slot-scope="scope">
          <img :src="scope.row.icon" alt class="imgwid" />
        </template>
      </el-table-column>
      <el-table-column label="文档地址" align="center">
        <template slot-scope="scope">
          <span style="margin-left: 10px">{{ scope.row.showUrl }}</span>
        </template>
      </el-table-column>
      <el-table-column label="创建人" align="center">
        <template slot-scope="scope">
          <span style="margin-left: 10px">{{ scope.row.creater }}</span>
        </template>
      </el-table-column>
      <el-table-column label="创建时间" align="center">
        <template slot-scope="scope">
          <span style="margin-left: 10px">{{
            scope.row.createTime | timefilters
          }}</span>
        </template>
      </el-table-column>
      <el-table-column align="center" label="操作" width="200">
        <template slot-scope="scope">
          <el-button type="text" size="small" @click="online(scope.row)"
            >在线编辑</el-button
          >
          <el-button type="text" size="small" @click="deletes(scope.row)"
            >删除</el-button
          >
          <el-button type="text" size="small" @click="amend(scope.row)"
            >修改</el-button
          >
        </template>
      </el-table-column>
    </el-table>
    <!-- 修改弹框 -->
    <el-dialog title="修改开发文档" :visible.sync="amendpopUp">
      <el-form :model="form" ref="form" label-width="100px">
        <el-form-item label="模块名称" prop="path">
          <el-input v-model="upform.name"></el-input>
        </el-form-item>
      </el-form>
      <el-form :model="form" ref="form" label-width="100px">
        <el-form-item label="图标" prop="path">
          <el-upload
            ref="upload"
            action="https://saas.jecinfo.com/gateway/api-file/files/upload"
            accept="image/png, image/gif, image/jpg, image/jpeg"
            list-type="picture-card"
            :limit="limitNum"
            :auto-upload="false"
            :before-upload="handleBeforeUpload"
            :on-preview="handlePictureCardPreview"
            :on-remove="handleRemove"
            :on-change="imgChange"
            :on-success="imgSuccess"
            :class="{ hide: hideUpload }"
          >
            <img :src="upform.icon" class="avatar" />
          </el-upload>
        </el-form-item>
      </el-form>
      <div slot="footer" class="dialog-footer">
        <el-button @click="onamend">取消</el-button>
        <el-button type="primary" @click="suamend">保存</el-button>
      </div>
    </el-dialog>
    <!-- 文件预览弹框 -->
    <el-dialog title="文件预览" :visible.sync="PreviewBounced">
      <mavon-editor
        v-model="contents"
        :subfield="false"
        :boxShadow="false"
        defaultOpen="preview"
        :toolbarsFlag="false"
      />
    </el-dialog>
    <!-- 在线编辑弹框 -->
    <el-dialog title="在线编辑" :visible.sync="quilleditor">
      <mavon-editor
        style="height: 100%"
        v-model="content"
        @change="change"
        :ishljs="true"
        @save="saveMavon"
        ref="md"
        @imgAdd="imgAdd"
        @imgDel="imgDel"
      ></mavon-editor>
    </el-dialog>
    <div class="development-box"></div>
    <el-dialog title="新增开发文档" :visible.sync="dialogFormVisible">
      <el-form :model="form" ref="form" :rules="rules" label-width="100px">
        <el-form-item label="模块名称" prop="name">
          <el-input v-model="form.name"></el-input>
        </el-form-item>
      </el-form>
      <el-form :model="form" ref="form" label-width="100px">
        <el-form-item label="图标">
          <el-upload
            ref="upload"
            action="https://saas.jecinfo.com/gateway/api-file/files/upload"
            accept="image/png, image/gif, image/jpg, image/jpeg"
            list-type="picture-card"
            :limit="limitNum"
            :auto-upload="false"
            :before-upload="handleBeforeUpload"
            :on-preview="handlePictureCardPreview"
            :on-remove="handleRemove"
            :on-change="imgChange"
            :on-success="imgSuccess"
            :class="{ hide: hideUpload }"
          >
            <img v-if="imageUrl" :src="imageUrl" class="avatar" />
            <i v-else class="el-icon-plus avatar-uploader-icon"></i>
          </el-upload>
        </el-form-item>
      </el-form>
      <el-form label-width="100px">
        <el-form-item label="文档上传" ref="uploadElement">
          <el-upload
            ref="uploadExcel"
            action="https://saas.jecinfo.com/gateway/api-file/files/upload"
            :limit="limitNum"
            :auto-upload="false"
            :data="uploadData"
            accept=".md"
            :before-upload="beforeUploadFile"
            :on-change="fileChange"
            :on-exceed="exceedFile"
            :on-success="handleSuccess"
            :on-error="handleError"
            :file-list="fileList"
          >
            <el-button size="small" plain>选择文件</el-button>
            <div slot="tip" class="el-upload__tip">只能上传.md文件</div>
          </el-upload>
        </el-form-item>
      </el-form>
      <div slot="footer" class="dialog-footer">
        <el-button @click="preview" :disabled="bools">文档预览</el-button>
        <el-button type="primary" @click="submit" v-if="bool">提 交</el-button>
      </div>
    </el-dialog>
  </d2-container>
</template>
<script>
import axios from "axios";
import {
  getlist,
  pstdelete,
  addsave,
  pupdate,
  deletes,
} from "@/api/development";
import { mavonEditor } from "mavon-editor";
import "mavon-editor/dist/css/index.css";

export default {
  components: {
    mavonEditor,
  },
  data() {
    return {
      contents: null,
      imageUrl: "",
      fileList: [],
      limitNum: 1,
      aaa: null,
      list: null,
      dialogFormVisible: false,
      quilleditor: false,
      amendpopUp: false,
      PreviewBounced: false,
      treeData: [],
      upform: {
        name: undefined,
        icon: undefined,
        creater: undefined,
      },
      bool: false,
      bools: true,
      form: {
        file: "",
        showUrl: null,
        id: null,
      },
      idd: null,
      hideUpload: false,
      mdText: {
        id: null,
        namespace: null,
        content: null,
      },
      uploadData: {
        namespace: "develop",
      },
      obj: {
        imit: 10,
        page: 1,
      },
      tableKey: 0,
      content: "加载中...",
      img_file: {},
      fileid: null,
      rules: {
        name: [{ required: true, message: "请输入模块名称", trigger: "blur" }],
      },
    };
  },
  filters: {
    timefilters(val) {
      if (val == null || val === "") {
        return "—";
      } else {
        let d = new Date(val);
        let month =
          d.getMonth() + 1 < 10 ? "0" + (d.getMonth() + 1) : d.getMonth() + 1;
        let day = d.getDate() < 10 ? "0" + d.getDate() : d.getDate();
        let hours = d.getHours() < 10 ? "0" + d.getHours() : d.getHours();
        let min = d.getMinutes() < 10 ? "0" + d.getMinutes() : d.getMinutes();
        let sec = d.getSeconds() < 10 ? "0" + d.getSeconds() : d.getSeconds();
        let times =
          d.getFullYear() +
          "-" +
          month +
          "-" +
          day +
          " " +
          hours +
          ":" +
          min +
          ":" +
          sec;
        return times;
      }
    },
  },
  created() {
    this.getList();
  },
  computed: {
    editor() {
      return this.$refs.myTextEditor.quillEditor;
    },
  },
  methods: {
    handleBeforeUpload(file) {
      if (
        !(
          file.type === "image/png" ||
          file.type === "image/gif" ||
          file.type === "image/jpg" ||
          file.type === "image/jpeg"
        )
      ) {
        this.$notify.warning({
          title: "警告",
          message:
            "请上传格式为image/png, image/gif, image/jpg, image/jpeg的图片",
        });
      }
      let size = file.size / 1024 / 1024 / 2;
      if (size > 2) {
        this.$notify.warning({
          title: "警告",
          message: "图片大小必须小于2M",
        });
      }
    },
    // 文件列表移除文件时的钩子
    handleRemove(file, fileList) {
      this.hideUpload = fileList.length >= this.limitNum;
    },
    // 点击文件列表中已上传的文件时的钩子
    handlePictureCardPreview(file) {
      this.dialogImageUrl = file.url;
      this.dialogVisible = true;
    },
    imgChange(files, fileList) {
      this.$refs.upload.submit();
      this.hideUpload = fileList.length >= this.limitNum;
    },
    imgSuccess(res, file, fileList) {
      console.log(file.response.data);
      this.form.icon =
        "https://saas.jecinfo.com/gateway/api-file" + file.response.data;
    },
    // Markdown保存
    saveMavon(value, render) {
      let obj = {
        id: this.fileid,
        namespace: this.mdText.namespace,
      };
      console.log(this.mdText);
      if (this.fileid != null) {
        deletes(obj).then((res) => {
          this.getList();
        });
        this.mdText.content = value;
        axios
          .post(
            "https://saas.jecinfo.com/gateway/api-file/files/updateMd",
            this.mdText
          )
          .then((res) => {
            if (res.status === 200) {
              this.$message.success("保存成功");
            } else {
              this.$message.success("保存失败");
            }
          });
      } else {
        this.mdText.content = value;
        axios
          .post(
            "https://saas.jecinfo.com/gateway/api-file/files/updateMd",
            this.mdText
          )
          .then((res) => {
            if (res.status === 200) {
              this.getList();
              this.$message.success("保存成功");
            } else {
              this.$message.success("保存失败");
            }
          });
      }
    },
    change(value, render) {
      // console.log(value)
    },
    // 绑定imgAdd event
    imgAdd(pos, file) {
      // 第一步.将图片上传到服务器.
      var formdata = new FormData();
      formdata.append("file", file);
      this.img_file[pos] = file;
      axios
        .post(
          "https://saas.jecinfo.com/gateway/api-file/files/upload",
          formdata
        )
        .then((res) => {
          let _res = res.data.data;
          console.log(this.$refs.md.$img2Url);
          // 第二步.将返回的url替换到文本原位置[外链图片转存失败(img-Anv63SQR-1564734760257)(0)] -> [外链图片转存失败(img-OVX7vZS4-1564734760259)(url)]
          this.$refs.md.$img2Url(
            pos,
            "https://saas.jecinfo.com/gateway/api-file" + _res
          );
        });
    },
    imgDel(pos) {
      delete this.img_file[pos];
    },
    // 文件超出个数限制时的钩子
    exceedFile(files, fileList) {
      this.$notify.warning({
        title: "警告",
        message: `只能选择 ${this.limitNum} 个文件，当前共选择了 ${
          files.length + fileList.length
        } 个`,
      });
    },
    // 文件状态改变时的钩子
    fileChange(file, fileList) {
      this.bools = false;
      this.form.file = file.raw;
      this.$refs.uploadExcel.submit();
    },
    // 上传文件之前的钩子, 参数为上传的文件,若返回 false 或者返回 Promise 且被 reject，则停止上传
    beforeUploadFile(file) {
      let size = file.size / 1024 / 1024;
      if (size > 10) {
        this.$notify.warning({
          title: "警告",
          message: `文件大小不得超过10M`,
        });
      }
    },
    // 文件上传成功时的钩子
    handleSuccess(res, file, fileList) {
      this.bools = true;
      this.form.showUrl = file.response.data;
      this.form.id = file.response.data.split("/")[
        file.response.data.split("/").length - 1
      ];

      this.$notify.success({
        title: "成功",
        message: `文件上传成功`,
      });
    },
    // 文件上传失败时的钩子
    handleError() {
      this.$notify.error({
        title: "错误",
        message: `文件上传失败`,
      });
    },
    getList() {
      getlist(this.obj).then((res) => {
        this.list = res.data.data;
        console.log(res);
      });
      console.log(this.obj);
      getlist(this.obj).then((res) => {
        // this.list = res.data.data;
        console.log(res, "-----");
      });
    },
    deletes(val) {
      let obj = {
        Id: val.id,
      };
      console.log(val);
      this.$confirm("此操作将永久删除, 是否继续?", "提示", {
        confirmButtonText: "确定",
        cancelButtonText: "取消",
        type: "warning",
      }).then(() => {
        pstdelete(obj).then((res) => {
          if (res.status === 200) {
            this.getList();
            this.$notify({
              title: "成功",
              message: "删除成功",
              type: "success",
              duration: 2000,
            });
          }
        });
      });
    },
    amend(val) {
      console.log(val);
      this.upform.id = val.id;
      this.upform.creater = val.creater;
      this.upform.icon = val.icon;
      this.upform.name = val.name;
      this.amendpopUp = true;
    },
    onamend() {
      this.amendpopUp = false;
    },
    suamend() {
      this.upform.icon = this.form.icon;
      pupdate(this.upform).then((res) => {
        if (res.status === 200) {
          this.getList();
          this.amendpopUp = false;
          this.$notify.success({
            title: "成功",
            message: `修改成功`,
          });
        } else {
          this.$notify.error({
            title: "失败",
            message: `修改失败`,
          });
        }
      });
    },
    online(val) {
      this.quilleditor = true;
      console.log(val);
      this.idd = val.id;
      this.content = "加载中...";
      if (val.showUrl != null) {
        this.fileid = val.showUrl.split("/")[val.showUrl.split("/").length - 1];
        this.mdText.id = val.id;
        this.mdText.namespace = val.showUrl.split("/")[2];
        axios
          .get("https://saas.jecinfo.com/gateway/api-file" + val.showUrl)
          .then((res) => {
            this.content = res.data.toString();
          });
      } else {
        this.fileid = null;
        this.mdText.id = val.id;
        this.mdText.namespace = "develop";
        this.content = "";
      }
    },
    // 新增菜单
    handleAdd() {
      this.dialogFormVisible = true;
      this.bool = true;
      this.form = {};
      this.fileList = [];
      this.bools = true;
    },
    // 关闭添加模态框
    preview() {
      if (this.form.showUrl == null) {
        console.log(11);
      } else {
        this.PreviewBounced = true;
        axios
          .get("https://saas.jecinfo.com/gateway/api-file/" + this.form.showUrl)
          .then((res) => {
            this.contents = res.data;
            console.log(res);
          });
      }
    },
    // 添加信息
    submit() {
      let obj = {
        showUrl: this.form.showUrl,
        name: this.form.name,
        icon: this.form.icon,
      };
      addsave(obj).then((res) => {
        if (res.status === 200) {
          this.getList();
          this.dialogFormVisible = false;
        }
      });
    },
  },
};
</script>

<style  lang="scss">
.imgwid {
  width: 50px;
  height: 50px;
}
.page {
  .cell {
    display: flex;
    .item {
      display: flex;
      flex-direction: column;
      flex: 1;
      height: 300px;
      & + .item {
        margin-left: 20px;
      }
      .title {
        text-align: center;
        line-height: 2em;
        font-size: 18px;
        font-weight: bold;
        color: #555;
      }
    }
  }
}
.avatar-uploader .el-upload {
  border: 1px dashed #d9d9d9;
  border-radius: 6px;
  cursor: pointer;
  position: relative;
  overflow: hidden;
}
.avatar-uploader .el-upload:hover {
  border-color: #409eff;
}
.avatar-uploader-icon {
  font-size: 28px;
  color: #8c939d;
  width: 178px;
  height: 178px;
  line-height: 178px;
  text-align: center;
}
.hide .el-upload--picture-card {
  display: none;
}
.avatar {
  width: 100%;
  height: 100%;
}
.dialogHtml {
  width: 100%;
  height: 100%;
}
/* .development-box{
  width: 100%;
  height: 100%;
  background: red;
  position: ;
  z-index: 9;
} */
.el-dialog__body {
  padding: 50px 20px;
}
.editor {
  line-height: normal !important;
  height: 450px;
}
.ql-container {
  height: 350px;
}
.ql-snow .ql-tooltip[data-mode="link"]::before {
  content: "请输入链接地址:";
}
.ql-snow .ql-tooltip.ql-editing a.ql-action::after {
  border-right: 0px;
  content: "保存";
  padding-right: 0px;
}

.ql-snow .ql-tooltip[data-mode="video"]::before {
  content: "请输入视频地址:";
}

.ql-snow .ql-picker.ql-size .ql-picker-label::before,
.ql-snow .ql-picker.ql-size .ql-picker-item::before {
  content: "14px";
}
.ql-snow .ql-picker.ql-size .ql-picker-label[data-value="small"]::before,
.ql-snow .ql-picker.ql-size .ql-picker-item[data-value="small"]::before {
  content: "10px";
}
.ql-snow .ql-picker.ql-size .ql-picker-label[data-value="large"]::before,
.ql-snow .ql-picker.ql-size .ql-picker-item[data-value="large"]::before {
  content: "18px";
}
.ql-snow .ql-picker.ql-size .ql-picker-label[data-value="huge"]::before,
.ql-snow .ql-picker.ql-size .ql-picker-item[data-value="huge"]::before {
  content: "32px";
}

.ql-snow .ql-picker.ql-header .ql-picker-label::before,
.ql-snow .ql-picker.ql-header .ql-picker-item::before {
  content: "文本";
}
.ql-snow .ql-picker.ql-header .ql-picker-label[data-value="1"]::before,
.ql-snow .ql-picker.ql-header .ql-picker-item[data-value="1"]::before {
  content: "标题1";
}
.ql-snow .ql-picker.ql-header .ql-picker-label[data-value="2"]::before,
.ql-snow .ql-picker.ql-header .ql-picker-item[data-value="2"]::before {
  content: "标题2";
}
.ql-snow .ql-picker.ql-header .ql-picker-label[data-value="3"]::before,
.ql-snow .ql-picker.ql-header .ql-picker-item[data-value="3"]::before {
  content: "标题3";
}
.ql-snow .ql-picker.ql-header .ql-picker-label[data-value="4"]::before,
.ql-snow .ql-picker.ql-header .ql-picker-item[data-value="4"]::before {
  content: "标题4";
}
.ql-snow .ql-picker.ql-header .ql-picker-label[data-value="5"]::before,
.ql-snow .ql-picker.ql-header .ql-picker-item[data-value="5"]::before {
  content: "标题5";
}
.ql-snow .ql-picker.ql-header .ql-picker-label[data-value="6"]::before,
.ql-snow .ql-picker.ql-header .ql-picker-item[data-value="6"]::before {
  content: "标题6";
}

.ql-snow .ql-picker.ql-font .ql-picker-label::before,
.ql-snow .ql-picker.ql-font .ql-picker-item::before {
  content: "标准字体";
}
.ql-snow .ql-picker.ql-font .ql-picker-label[data-value="serif"]::before,
.ql-snow .ql-picker.ql-font .ql-picker-item[data-value="serif"]::before {
  content: "衬线字体";
}
.ql-snow .ql-picker.ql-font .ql-picker-label[data-value="monospace"]::before,
.ql-snow .ql-picker.ql-font .ql-picker-item[data-value="monospace"]::before {
  content: "等宽字体";
}
</style>
